<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—å•†ç†±éŸ³ç¤¾ - ç·´åœ˜å®¤é ç´„ç³»çµ±</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ä¿æŒåŸæœ‰çš„ CSS æ¨£å¼ */
        :root {
            --primary-color: #4da6ff;
            --primary-light: #e6f2ff;
            --primary-dark: #0066cc;
            --secondary-color: #66b3ff;
            --accent-color: #99ccff;
            --text-color: #333;
            --light-text: #666;
            --background-color: #f5fbff;
            --card-color: #ffffff;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --error-color: #F44336;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0, 102, 204, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: transparent;
            color: var(--text-color);
            padding: 20px 0;
            margin-bottom: 30px;
            text-align: center;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .logo i {
            font-size: 2.5rem;
            color: var(--primary-color);
        }

        .logo h1 {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .gallery-container {
            position: relative;
            width: 80%;
            height: 0;
            padding-bottom: 45%;
            overflow: hidden;
            border-radius: 10px;
            margin: 15px auto;
            max-width: 800px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .gallery-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }

        .gallery-slide.active {
            opacity: 1;
        }

        .gallery-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card {
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 25px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 102, 204, 0.15);
        }

        .card-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid var(--primary-light);
            padding-bottom: 10px;
        }

        .login-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 500px;
            margin: 0 auto;
        }

        .login-form {
            width: 100%;
        }

        .form-group {
            margin-bottom: 20px;
            width: 100%;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--accent-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            display: inline-block;
            padding: 12px 25px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            text-align: center;
        }

        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: #3d8b40;
        }

        .btn-danger {
            background-color: var(--error-color);
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--light-text);
            margin-bottom: 10px;
        }

        .sync-status.syncing {
            color: var(--warning-color);
        }

        .sync-status.synced {
            color: var(--success-color);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin: 10px 0;
        }

        .stat-label {
            font-size: 1rem;
            color: var(--light-text);
        }

        .calendar-container {
            overflow-x: auto;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .calendar th {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
        }

        .calendar td {
            border: 1px solid var(--accent-color);
            padding: 10px;
            vertical-align: top;
            height: 120px;
            width: 14.28%;
        }

        .date-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .today {
            background-color: var(--primary-light);
        }

        .time-slots {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .time-slot {
            padding: 5px 8px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .time-slot.available {
            background-color: #e8f5e9;
            color: var(--success-color);
            border: 1px solid #c8e6c9;
        }

        .time-slot.booked {
            background-color: #ffebee;
            color: var(--error-color);
            border: 1px solid #ffcdd2;
        }

        .time-slot.own-booking {
            background-color: #e3f2fd;
            color: var(--primary-dark);
            border: 1px solid #bbdefb;
        }

        .time-slot.available:hover {
            background-color: #c8e6c9;
        }

        .time-slot.own-booking:hover {
            background-color: #bbdefb;
        }

        .time-slot.past {
            background-color: #f5f5f5;
            color: #9e9e9e;
            cursor: not-allowed;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.4rem;
            color: var(--primary-dark);
        }

        .close {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--light-text);
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: var(--light-text);
            font-size: 0.9rem;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .alert {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1100;
            min-width: 300px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .alert-success {
            background-color: #e8f5e9;
            color: var(--success-color);
            border: 1px solid #c8e6c9;
        }

        .alert-error {
            background-color: #ffebee;
            color: var(--error-color);
            border: 1px solid #ffcdd2;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--light-text);
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .calendar td {
                height: 100px;
            }
            
            .time-slot {
                font-size: 0.75rem;
                padding: 3px 5px;
            }
            
            .gallery-container {
                width: 90%;
                padding-bottom: 50%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <h1>åŒ—å•†ç†±éŸ³ç¤¾ç·´åœ˜å®¤é ç´„ç³»çµ±</h1>
            </div>
            <div class="gallery-container" id="galleryContainer">
                <div class="gallery-slide active">
                    <img src="imgs/LINE_ALBUM_2025326_251119_1.jpg" alt="æ¨‚åœ˜è¡¨æ¼”" loading="lazy">
                </div>
                <div class="gallery-slide">
                    <img src="imgs/LINE_ALBUM_202539_251119_1.jpg" alt="éŒ„éŸ³å®¤" loading="lazy">
                </div>
                <div class="gallery-slide">
                    <img src="imgs/LINE_ALBUM_2025427_251119_1.jpg" alt="å‰ä»–æ‰‹" loading="lazy">
                </div>
                <div class="gallery-slide">
                    <img src="imgs/LINE_ALBUM_2025427_251119_2.jpg" alt="é¼“æ‰‹" loading="lazy">
                </div>
                <div class="gallery-slide">
                    <img src="imgs/LINE_ALBUM_202568æ·¨ç˜_251119_1.jpg" alt="æ·¨ç˜æ´»å‹•" loading="lazy">
                </div>
            </div>
        </header>

        <!-- ç™»å…¥å€å¡Š -->
        <section id="loginSection" class="card login-section">
            <h2 class="card-title"><i class="fas fa-sign-in-alt"></i> ç¤¾å“¡èº«ä»½é©—è­‰</h2>
            <p style="margin-bottom: 20px; text-align: center;">è«‹è¼¸å…¥æ‚¨çš„æœ¬åé€²è¡Œèº«ä»½é©—è­‰ï¼Œéç¤¾å“¡åƒ…èƒ½æŸ¥çœ‹é ç´„ç‹€æ³</p>
            
            <div class="login-form">
                <div class="form-group">
                    <label for="userName">æ‚¨çš„æœ¬å</label>
                    <input type="text" id="userName" class="form-control" placeholder="è«‹è¼¸å…¥æ‚¨çš„æœ¬å">
                </div>
                <button id="loginBtn" class="btn btn-block">é©—è­‰èº«ä»½</button>
                <button id="viewOnlyBtn" class="btn btn-block" style="margin-top: 10px; background-color: var(--secondary-color);">åƒ…æŸ¥çœ‹é ç´„ç‹€æ³</button>
            </div>
        </section>

        <!-- ä¸»å…§å®¹å€å¡Š -->
        <section id="mainContent" style="display: none;">
            <!-- ç”¨æˆ¶è³‡è¨Š -->
            <div class="user-info card">
                <div>
                    <h3>æ­¡è¿, <span id="currentUser">ç”¨æˆ¶</span></h3>
                    <p id="userRole" style="color: var(--light-text);">ç¤¾å“¡</p>
                    <div class="sync-status" id="syncStatus">
                        <i class="fas fa-sync"></i>
                        <span>è³‡æ–™åŒæ­¥ä¸­...</span>
                    </div>
                </div>
                <button id="logoutBtn" class="btn">ç™»å‡º</button>
            </div>

            <!-- çµ±è¨ˆå„€è¡¨æ¿ -->
            <div class="dashboard">
                <div class="card stat-card">
                    <i class="fas fa-users fa-2x" style="color: var(--primary-color);"></i>
                    <div class="stat-value" id="monthUsers">0</div>
                    <div class="stat-label">æœ¬æœˆä½¿ç”¨äººæ•¸</div>
                </div>
                <div class="card stat-card">
                    <i class="fas fa-calendar-day fa-2x" style="color: var(--success-color);"></i>
                    <div class="stat-value" id="todayBookings">0</div>
                    <div class="stat-label">ä»Šæ—¥é ç´„æ•¸</div>
                </div>
                <div class="card stat-card">
                    <i class="fas fa-check-circle fa-2x" style="color: var(--warning-color);"></i>
                    <div class="stat-value" id="totalBookings">0</div>
                    <div class="stat-label">ç¸½é ç´„å®Œæˆæ•¸</div>
                </div>
                <div class="card stat-card">
                    <i class="fas fa-chart-pie fa-2x" style="color: var(--error-color);"></i>
                    <div class="stat-value" id="bookingRate">0%</div>
                    <div class="stat-label">æ™‚æ®µé ç´„ç‡</div>
                </div>
            </div>

            <!-- é ç´„æ—¥æ›† -->
            <div class="card">
                <div class="calendar-header">
                    <h2 class="card-title"><i class="fas fa-calendar-alt"></i> ç·´åœ˜å®¤é ç´„æ—¥æ›†</h2>
                    <div class="calendar-nav">
                        <button id="prevWeek" class="btn"><i class="fas fa-chevron-left"></i> ä¸Šé€±</button>
                        <button id="currentWeek" class="btn">æœ¬é€±</button>
                        <button id="nextWeek" class="btn">ä¸‹é€± <i class="fas fa-chevron-right"></i></button>
                        <button id="refreshBtn" class="btn" style="background-color: var(--success-color);">
                            <i class="fas fa-sync-alt"></i> é‡æ–°æ•´ç†
                        </button>
                    </div>
                </div>
                
                <div class="loading" id="calendarLoading">
                    <i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...
                </div>
                
                <div class="calendar-container">
                    <table class="calendar">
                        <thead>
                            <tr>
                                <th>é€±ä¸€</th>
                                <th>é€±äºŒ</th>
                                <th>é€±ä¸‰</th>
                                <th>é€±å››</th>
                                <th>é€±äº”</th>
                                <th>é€±å…­</th>
                                <th>é€±æ—¥</th>
                            </tr>
                        </thead>
                        <tbody id="calendarBody">
                            <!-- æ—¥æ›†å…§å®¹å°‡ç”±JavaScriptç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- é ç´„ç¢ºèªæ¨¡æ…‹æ¡† -->
        <div id="bookingModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">é ç´„ç¢ºèª</h3>
                    <span class="close">&times;</span>
                </div>
                <p>æ‚¨å³å°‡é ç´„ï¼š</p>
                <p id="bookingDetails" style="font-weight: 600; margin: 10px 0;"></p>
                <p>è«‹ç¢ºèªç„¡èª¤å¾Œé€²è¡Œé ç´„</p>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button id="confirmBooking" class="btn btn-success">ç¢ºèªé ç´„</button>
                    <button id="cancelBooking" class="btn">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- å–æ¶ˆé ç´„æ¨¡æ…‹æ¡† -->
        <div id="cancelModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">å–æ¶ˆé ç´„</h3>
                    <span class="close">&times;</span>
                </div>
                <p>æ‚¨ç¢ºå®šè¦å–æ¶ˆä»¥ä¸‹é ç´„å—ï¼Ÿ</p>
                <p id="cancelDetails" style="font-weight: 600; margin: 10px 0;"></p>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button id="confirmCancel" class="btn btn-danger">ç¢ºèªå–æ¶ˆ</button>
                    <button id="cancelCancel" class="btn">è¿”å›</button>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>GDG on Campus NTUB &copy; <span id="currentYear"></span> | å°åŒ—å•†æ¥­å¤§å­¸ç†±éŸ³ç¤¾ç·´åœ˜å®¤é ç´„ç¶²</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // ğŸ”¥ Firebase é…ç½®
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            addDoc, 
            doc, 
            deleteDoc, 
            setDoc,
            serverTimestamp,
            query,
            where,
            orderBy,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBDIPsWgHaBljZEdK3Xkjt19vLgGCOUWsg",
            authDomain: "ntub-music-booking.firebaseapp.com",
            projectId: "ntub-music-booking",
            storageBucket: "ntub-music-booking.firebasestorage.app",
            messagingSenderId: "181138609050",
            appId: "1:181138609050:web:92b657392017ee637c2023",
            measurementId: "G-BE6STHBQV7"
        };

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ç¤¾å“¡åå–®
        const members = [
            "å§œå®å¡", "å¤æ¹˜è¡", "è”¡å®œéœ", "é™³å®¥ä»»", "é™³ç¾¿è¯", 
            "é™³å¯æ¬£", "æå®¶ç‘€", "è˜‡æ˜Ÿè", "å»–æ¢“å", "å§šé¨°å´´",
            "è‘£å€‰é³´", "ç‹æ²‚æ•", "è”¡æ˜€å­¸", "ç››è‹±åº­", "é™³è©©æ¨º",
            "æ—æ€å®‡", "æ›¹èˆˆç¾½", "å¼µèŠ¯æ™¨", "ç‹éµ¬ç‘‹", "è¬ä¹…ç¾²",
            "è”¡æ˜•å¦¤", "é­éšç‘„", "è¬æ˜•å±•", "è”¡æ…ˆé¨µ", "é»ƒäº®æ¬Š",
            "é„­æ€¡å©·", "å‘¨åº­å®‰", "é™³ç´¹ç·¯", "åŠ‰äº¦æ©", "å‘‚å…¶è“",
            "è¨±åˆæ©", "é»ƒå­æ©", "è˜‡å¿»æ¶µ", "ç‹æŸå…ƒ", "å³å®¥èŠ¹",
            "è©¹å­å„€", "æ—ç¥ç«‹", "åŠ‰ç»é™½", "å¼µæ›¸ç¿Š", "è¨±èŠ·æ¶µ",
            "é­éšç‘„", "å¼µç¿èŠ¯", "å¼µè© æ€¡"
        ];

        // å…¨åŸŸè®Šæ•¸
        let currentUser = null;
        let currentWeekStart = new Date();
        let selectedBooking = null;
        let galleryInterval;
        let bookings = [];
        let usageStats = {
            monthUsers: [],
            todayBookings: 0,
            totalBookings: 0
        };
        let unsubscribeBookings = null;
        let isInitialLoad = true;
        let useSimpleQuery = true; // ä½¿ç”¨ç°¡å–®æŸ¥è©¢é¿å…ç´¢å¼•å•é¡Œ

        // DOM å…ƒç´ 
        const loginSection = document.getElementById('loginSection');
        const mainContent = document.getElementById('mainContent');
        const userNameInput = document.getElementById('userName');
        const loginBtn = document.getElementById('loginBtn');
        const viewOnlyBtn = document.getElementById('viewOnlyBtn');
        const currentUserSpan = document.getElementById('currentUser');
        const userRoleSpan = document.getElementById('userRole');
        const logoutBtn = document.getElementById('logoutBtn');
        const calendarBody = document.getElementById('calendarBody');
        const prevWeekBtn = document.getElementById('prevWeek');
        const nextWeekBtn = document.getElementById('nextWeek');
        const currentWeekBtn = document.getElementById('currentWeek');
        const refreshBtn = document.getElementById('refreshBtn');
        const bookingModal = document.getElementById('bookingModal');
        const cancelModal = document.getElementById('cancelModal');
        const bookingDetails = document.getElementById('bookingDetails');
        const cancelDetails = document.getElementById('cancelDetails');
        const confirmBookingBtn = document.getElementById('confirmBooking');
        const cancelBookingBtn = document.getElementById('cancelBooking');
        const confirmCancelBtn = document.getElementById('confirmCancel');
        const cancelCancelBtn = document.getElementById('cancelCancel');
        const closeButtons = document.querySelectorAll('.close');
        const galleryContainer = document.getElementById('galleryContainer');
        const currentYearSpan = document.getElementById('currentYear');
        const syncStatus = document.getElementById('syncStatus');
        const calendarLoading = document.getElementById('calendarLoading');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è¨­ç½®ç•¶å‰å¹´ä»½
            currentYearSpan.textContent = new Date().getFullYear();
            
            // è¨­å®šæœ¬é€±é–‹å§‹æ—¥æœŸï¼ˆé€±ä¸€ï¼‰
            const today = new Date();
            const dayOfWeek = today.getDay();
            const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() + diffToMonday);
            
            // é è¼‰å…¥è³‡æ–™
            preloadData();
            startGallery();
            
            // äº‹ä»¶ç›£è½å™¨
            loginBtn.addEventListener('click', handleLogin);
            viewOnlyBtn.addEventListener('click', handleViewOnly);
            logoutBtn.addEventListener('click', handleLogout);
            prevWeekBtn.addEventListener('click', goToPrevWeek);
            nextWeekBtn.addEventListener('click', goToNextWeek);
            currentWeekBtn.addEventListener('click', goToCurrentWeek);
            refreshBtn.addEventListener('click', forceRefresh);
            confirmBookingBtn.addEventListener('click', confirmBooking);
            cancelBookingBtn.addEventListener('click', () => bookingModal.style.display = 'none');
            confirmCancelBtn.addEventListener('click', confirmCancel);
            cancelCancelBtn.addEventListener('click', () => cancelModal.style.display = 'none');
            
            closeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    bookingModal.style.display = 'none';
                    cancelModal.style.display = 'none';
                });
            });
            
            // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
            window.addEventListener('click', function(event) {
                if (event.target === bookingModal) {
                    bookingModal.style.display = 'none';
                }
                if (event.target === cancelModal) {
                    cancelModal.style.display = 'none';
                }
            });
        });

        // ğŸ”¥ é è¼‰å…¥è³‡æ–™ - æœ€å¿«çš„åˆå§‹åŒ–æ–¹å¼
        async function preloadData() {
            updateSyncStatus('syncing', 'å¿«é€Ÿè¼‰å…¥ä¸­...');
            
            try {
                // ä¸¦è¡Œè¼‰å…¥æ‰€æœ‰è³‡æ–™
                const [bookingsData, statsData] = await Promise.allSettled([
                    loadBookingsData(),
                    loadStatsData()
                ]);

                if (bookingsData.status === 'fulfilled') {
                    bookings = bookingsData.value;
                }

                if (statsData.status === 'fulfilled' && statsData.value) {
                    usageStats = statsData.value;
                }

                updateStats();
                renderCalendar();
                updateSyncStatus('synced', 'è³‡æ–™å·²å°±ç·’');
                
                // å•Ÿå‹•å³æ™‚ç›£è½
                startRealtimeListener();
                
                console.log('å¿«é€Ÿè¼‰å…¥å®Œæˆ:', bookings.length, 'ç­†é ç´„');
            } catch (error) {
                console.error('é è¼‰å…¥éŒ¯èª¤:', error);
                handleLoadError(error);
            }
        }

        // ğŸ”¥ è¼‰å…¥é ç´„è³‡æ–™ï¼ˆå„ªåŒ–æŸ¥è©¢ - é¿å…ç´¢å¼•å•é¡Œï¼‰
        async function loadBookingsData() {
            try {
                // æ–¹æ³•1ï¼šä½¿ç”¨ç°¡å–®æŸ¥è©¢ï¼ˆä¸éœ€è¦ç´¢å¼•ï¼‰
                if (useSimpleQuery) {
                    const snapshot = await getDocs(collection(db, 'bookings'));
                    const data = [];
                    snapshot.forEach(doc => {
                        const bookingData = doc.data();
                        // åœ¨å®¢æˆ¶ç«¯éæ¿¾æœ€è¿‘30å¤©çš„è³‡æ–™
                        const bookingDate = new Date(bookingData.date);
                        const thirtyDaysAgo = new Date();
                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        
                        if (bookingDate >= thirtyDaysAgo) {
                            data.push({
                                id: doc.id,
                                ...bookingData
                            });
                        }
                    });
                    // åœ¨å®¢æˆ¶ç«¯æ’åº
                    data.sort((a, b) => {
                        if (a.date === b.date) {
                            return a.time.localeCompare(b.time);
                        }
                        return a.date.localeCompare(b.date);
                    });
                    return data;
                } else {
                    // æ–¹æ³•2ï¼šä½¿ç”¨è¤‡åˆæŸ¥è©¢ï¼ˆéœ€è¦ç´¢å¼•ï¼‰
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    const thirtyDaysAgoStr = getFormattedDate(thirtyDaysAgo);
                    
                    const q = query(
                        collection(db, 'bookings'),
                        where('date', '>=', thirtyDaysAgoStr),
                        orderBy('date'),
                        orderBy('time')
                    );
                    
                    const snapshot = await getDocs(q);
                    const data = [];
                    snapshot.forEach(doc => {
                        data.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    return data;
                }
            } catch (error) {
                console.error('è¼‰å…¥é ç´„è³‡æ–™éŒ¯èª¤:', error);
                if (error.code === 'failed-precondition') {
                    // å¦‚æœç´¢å¼•éŒ¯èª¤ï¼Œåˆ‡æ›åˆ°ç°¡å–®æŸ¥è©¢
                    useSimpleQuery = true;
                    return await loadBookingsData(); // é‡æ–°å˜—è©¦
                }
                throw error;
            }
        }

        // ğŸ”¥ è¼‰å…¥çµ±è¨ˆè³‡æ–™
        async function loadStatsData() {
            try {
                const statsDoc = await getDocs(collection(db, 'stats'));
                if (!statsDoc.empty) {
                    let stats = null;
                    statsDoc.forEach(doc => {
                        if (doc.id === 'usage') {
                            stats = doc.data();
                        }
                    });
                    return stats;
                }
            } catch (error) {
                console.log('çµ±è¨ˆè³‡æ–™å°šæœªå»ºç«‹');
            }
            return null;
        }

        // ğŸ”¥ å•Ÿå‹•å³æ™‚ç›£è½ï¼ˆå„ªåŒ–ç‰ˆæœ¬ï¼‰
        function startRealtimeListener() {
            if (unsubscribeBookings) {
                unsubscribeBookings(); // æ¸…é™¤èˆŠçš„ç›£è½
            }

            try {
                if (useSimpleQuery) {
                    // ä½¿ç”¨ç°¡å–®ç›£è½ï¼ˆä¸éœ€è¦ç´¢å¼•ï¼‰
                    const q = query(collection(db, 'bookings'));
                    
                    unsubscribeBookings = onSnapshot(q, 
                        (snapshot) => {
                            const updatedBookings = [];
                            snapshot.forEach(doc => {
                                const bookingData = doc.data();
                                // åœ¨å®¢æˆ¶ç«¯éæ¿¾æœ€è¿‘30å¤©çš„è³‡æ–™
                                const bookingDate = new Date(bookingData.date);
                                const thirtyDaysAgo = new Date();
                                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                                
                                if (bookingDate >= thirtyDaysAgo) {
                                    updatedBookings.push({
                                        id: doc.id,
                                        ...bookingData
                                    });
                                }
                            });
                            
                            // åœ¨å®¢æˆ¶ç«¯æ’åº
                            updatedBookings.sort((a, b) => {
                                if (a.date === b.date) {
                                    return a.time.localeCompare(b.time);
                                }
                                return a.date.localeCompare(b.date);
                            });
                            
                            bookings = updatedBookings;
                            updateStats();
                            if (!isInitialLoad) {
                                renderCalendar();
                            }
                            updateSyncStatus('synced', 'å³æ™‚åŒæ­¥ä¸­');
                        },
                        (error) => {
                            console.error('å³æ™‚ç›£è½éŒ¯èª¤:', error);
                            if (error.code === 'failed-precondition') {
                                useSimpleQuery = true;
                                startRealtimeListener(); // é‡æ–°å•Ÿå‹•ç°¡å–®ç›£è½
                            } else {
                                updateSyncStatus('error', 'å³æ™‚åŒæ­¥å¤±æ•—');
                            }
                        }
                    );
                } else {
                    // ä½¿ç”¨è¤‡åˆç›£è½ï¼ˆéœ€è¦ç´¢å¼•ï¼‰
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    const thirtyDaysAgoStr = getFormattedDate(thirtyDaysAgo);
                    
                    const q = query(
                        collection(db, 'bookings'),
                        where('date', '>=', thirtyDaysAgoStr),
                        orderBy('date'),
                        orderBy('time')
                    );

                    unsubscribeBookings = onSnapshot(q, 
                        (snapshot) => {
                            bookings = [];
                            snapshot.forEach(doc => {
                                bookings.push({
                                    id: doc.id,
                                    ...doc.data()
                                });
                            });
                            
                            updateStats();
                            if (!isInitialLoad) {
                                renderCalendar();
                            }
                            updateSyncStatus('synced', 'å³æ™‚åŒæ­¥ä¸­');
                        },
                        (error) => {
                            console.error('å³æ™‚ç›£è½éŒ¯èª¤:', error);
                            if (error.code === 'failed-precondition') {
                                // è‡ªå‹•åˆ‡æ›åˆ°ç°¡å–®æŸ¥è©¢æ¨¡å¼
                                useSimpleQuery = true;
                                startRealtimeListener();
                                showAlert('å·²åˆ‡æ›åˆ°ç°¡å–®æŸ¥è©¢æ¨¡å¼', 'warning');
                            } else {
                                updateSyncStatus('error', 'å³æ™‚åŒæ­¥å¤±æ•—');
                            }
                        }
                    );
                }

                isInitialLoad = false;
            } catch (error) {
                console.error('å•Ÿå‹•ç›£è½éŒ¯èª¤:', error);
                updateSyncStatus('error', 'ç›£è½å•Ÿå‹•å¤±æ•—');
            }
        }

        // ğŸ”¥ å¼·åˆ¶é‡æ–°æ•´ç†
        async function forceRefresh() {
            updateSyncStatus('syncing', 'å¼·åˆ¶é‡æ–°æ•´ç†ä¸­...');
            await preloadData();
            showAlert('è³‡æ–™å·²é‡æ–°æ•´ç†', 'success');
        }

        // ğŸ”¥ å„²å­˜çµ±è¨ˆè³‡æ–™åˆ° Firebase
        async function saveStats() {
            try {
                await setDoc(doc(db, 'stats', 'usage'), {
                    ...usageStats,
                    lastUpdated: serverTimestamp()
                });
                return true;
            } catch (error) {
                console.error('å„²å­˜çµ±è¨ˆè³‡æ–™éŒ¯èª¤:', error);
                return false;
            }
        }

        // ğŸ”¥ æ–°å¢é ç´„åˆ° Firebase
        async function addBooking(booking) {
            try {
                const docRef = await addDoc(collection(db, 'bookings'), {
                    date: booking.date,
                    time: booking.time,
                    user: booking.user,
                    timestamp: serverTimestamp(),
                    createdAt: new Date().toISOString()
                });
                booking.id = docRef.id;
                return true;
            } catch (error) {
                console.error('æ–°å¢é ç´„éŒ¯èª¤:', error);
                return false;
            }
        }

        // ğŸ”¥ å¾ Firebase åˆªé™¤é ç´„
        async function deleteBooking(bookingId) {
            try {
                await deleteDoc(doc(db, 'bookings', bookingId));
                console.log('æˆåŠŸå¾ Firebase åˆªé™¤é ç´„:', bookingId);
                return true;
            } catch (error) {
                console.error('åˆªé™¤é ç´„éŒ¯èª¤:', error);
                return false;
            }
        }

        // ğŸ”¥ è™•ç†è¼‰å…¥éŒ¯èª¤
        function handleLoadError(error) {
            console.error('è¼‰å…¥è³‡æ–™éŒ¯èª¤:', error);
            updateSyncStatus('error', 'ä½¿ç”¨æœ¬åœ°è³‡æ–™');
            
            // ä½¿ç”¨æœ¬åœ°å‚™ä»½è³‡æ–™
            const localBookings = localStorage.getItem('ntubMusicBookings');
            const localStats = localStorage.getItem('ntubMusicStats');
            
            if (localBookings) {
                bookings = JSON.parse(localBookings);
            }
            if (localStats) {
                usageStats = JSON.parse(localStats);
            }
            
            updateStats();
            renderCalendar();
            showAlert('ä½¿ç”¨æœ¬åœ°å‚™ä»½è³‡æ–™', 'error');
        }

        // æ›´æ–°åŒæ­¥ç‹€æ…‹
        function updateSyncStatus(status, message) {
            syncStatus.className = `sync-status ${status}`;
            syncStatus.innerHTML = `<i class="fas fa-sync${status === 'syncing' ? ' fa-spin' : ''}"></i><span>${message}</span>`;
        }

        // è—å»Šè¼ªæ’­åŠŸèƒ½
        function startGallery() {
            const slides = document.querySelectorAll('.gallery-slide');
            let currentSlide = 0;
            
            galleryInterval = setInterval(() => {
                slides[currentSlide].classList.remove('active');
                currentSlide = (currentSlide + 1) % slides.length;
                slides[currentSlide].classList.add('active');
            }, 5000);
        }

        // è™•ç†ç™»å…¥
        function handleLogin() {
            const userName = userNameInput.value.trim();
            
            if (!userName) {
                showAlert('è«‹è¼¸å…¥æ‚¨çš„å§“å', 'error');
                return;
            }
            
            if (members.includes(userName)) {
                currentUser = userName;
                currentUserSpan.textContent = userName;
                userRoleSpan.textContent = 'ç¤¾å“¡';
                loginSection.style.display = 'none';
                mainContent.style.display = 'block';
                
                // æ›´æ–°ä½¿ç”¨çµ±è¨ˆ
                updateUsageStats(userName);
                
                showAlert(`æ­¡è¿å›ä¾†ï¼Œ${userName}ï¼`, 'success');
            } else {
                showAlert('æ‚¨çš„å§“åä¸åœ¨ç¤¾å“¡åå–®ä¸­ï¼Œè«‹ç¢ºèªè¼¸å…¥æ­£ç¢º', 'error');
            }
        }

        // è™•ç†åƒ…æŸ¥çœ‹
        function handleViewOnly() {
            currentUser = null;
            currentUserSpan.textContent = 'è¨ªå®¢';
            userRoleSpan.textContent = 'åƒ…å¯æŸ¥çœ‹';
            loginSection.style.display = 'none';
            mainContent.style.display = 'block';
            showAlert('æ‚¨ç›®å‰ä»¥è¨ªå®¢èº«ä»½ç€è¦½ï¼Œåƒ…å¯æŸ¥çœ‹é ç´„ç‹€æ³', 'success');
        }

        // è™•ç†ç™»å‡º
        function handleLogout() {
            currentUser = null;
            userNameInput.value = '';
            mainContent.style.display = 'none';
            loginSection.style.display = 'block';
            
            // æ¸…é™¤ç›£è½
            if (unsubscribeBookings) {
                unsubscribeBookings();
                unsubscribeBookings = null;
            }
        }

        // æ›´æ–°ä½¿ç”¨çµ±è¨ˆ
        function updateUsageStats(userName) {
            // è¨˜éŒ„æœ¬æœˆä½¿ç”¨è€…
            if (userName && !usageStats.monthUsers.includes(userName)) {
                usageStats.monthUsers.push(userName);
            }
            
            // æ›´æ–°ä»Šæ—¥é ç´„æ•¸
            const today = getFormattedDate(new Date());
            usageStats.todayBookings = bookings.filter(booking => booking.date === today).length;
            
            // æ›´æ–°ç¸½é ç´„æ•¸
            usageStats.totalBookings = bookings.length;
            
            // è‡ªå‹•å„²å­˜çµ±è¨ˆè³‡æ–™
            saveStats();
        }

        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStats() {
            document.getElementById('monthUsers').textContent = usageStats.monthUsers ? usageStats.monthUsers.length : 0;
            document.getElementById('todayBookings').textContent = usageStats.todayBookings || 0;
            document.getElementById('totalBookings').textContent = bookings.length;
            document.getElementById('bookingRate').textContent = calculateBookingRate();
        }

        // ğŸ”¥ å„ªåŒ–çš„æ—¥æ›†æ¸²æŸ“
        function renderCalendar() {
            // é¡¯ç¤ºè¼‰å…¥ä¸­
            calendarLoading.style.display = 'block';
            calendarBody.style.opacity = '0.5';
            
            // ä½¿ç”¨ requestAnimationFrame é¿å…é˜»å¡
            requestAnimationFrame(() => {
                calendarBody.innerHTML = '';
                
                // å»ºç«‹æ™‚é–“æ®µ
                const timeSlots = [];
                for (let hour = 8; hour <= 21; hour++) {
                    const startTime = `${hour.toString().padStart(2, '0')}:00`;
                    const endTime = `${(hour + 1).toString().padStart(2, '0')}:00`;
                    timeSlots.push(`${startTime}-${endTime}`);
                }
                
                // å»ºç«‹ä¸€é€±çš„æ—¥æœŸ
                const weekDates = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(currentWeekStart);
                    date.setDate(currentWeekStart.getDate() + i);
                    weekDates.push(date);
                }
                
                // å»ºç«‹æ—¥æ›†è¡Œï¼ˆæ¯å€‹æ™‚é–“æ®µä¸€è¡Œï¼‰
                for (let i = 0; i < timeSlots.length; i++) {
                    const row = document.createElement('tr');
                    
                    for (let j = 0; j < 7; j++) {
                        const cell = document.createElement('td');
                        const date = weekDates[j];
                        const dateString = getFormattedDate(date);
                        const isToday = isSameDay(date, new Date());
                        
                        if (isToday) {
                            cell.classList.add('today');
                        }
                        
                        // æ—¥æœŸæ¨™é ­ï¼ˆåƒ…ç¬¬ä¸€è¡Œé¡¯ç¤ºï¼‰- ä¿®æ”¹ç‚ºåªé¡¯ç¤ºä¸€æ¬¡æ—¥æœŸ
                        if (i === 0) {
                            const dateHeader = document.createElement('div');
                            dateHeader.className = 'date-header';
                            dateHeader.innerHTML = `
                                <span>${formatMonth(date.getMonth() + 1)}/${date.getDate()}</span>
                            `;
                            cell.appendChild(dateHeader);
                        }
                        
                        // æ™‚é–“æ®µ
                        const timeSlot = document.createElement('div');
                        timeSlot.className = 'time-slot';
                        timeSlot.textContent = timeSlots[i];
                        
                        // æª¢æŸ¥æ˜¯å¦å¯é ç´„
                        const isPast = date < new Date().setHours(0, 0, 0, 0);
                        const isTooFar = date > new Date().setDate(new Date().getDate() + 60);
                        
                        // æª¢æŸ¥æ˜¯å¦å·²è¢«é ç´„
                        const existingBooking = bookings.find(booking => 
                            booking.date === dateString && booking.time === timeSlots[i]
                        );
                        
                        if (existingBooking) {
                            if (currentUser && existingBooking.user === currentUser) {
                                timeSlot.classList.add('own-booking');
                                timeSlot.innerHTML = `${timeSlots[i]} <br> <small>æ‚¨çš„é ç´„</small>`;
                                timeSlot.addEventListener('click', () => openCancelModal(existingBooking));
                            } else {
                                timeSlot.classList.add('booked');
                                timeSlot.innerHTML = `${timeSlots[i]} <br> <small>${existingBooking.user}å·²é ç´„</small>`;
                            }
                        } else if (isPast || isTooFar || !currentUser) {
                            timeSlot.classList.add('past');
                            if (isTooFar) {
                                timeSlot.innerHTML = `${timeSlots[i]} <br> <small>ä¸å¯é ç´„</small>`;
                            } else {
                                timeSlot.innerHTML = `${timeSlots[i]} <br> <small>ä¸å¯ç”¨</small>`;
                            }
                        } else {
                            timeSlot.classList.add('available');
                            timeSlot.addEventListener('click', () => openBookingModal(dateString, timeSlots[i]));
                        }
                        
                        cell.appendChild(timeSlot);
                        row.appendChild(cell);
                    }
                    
                    calendarBody.appendChild(row);
                }
                
                // éš±è—è¼‰å…¥ä¸­ï¼Œé¡¯ç¤ºæ—¥æ›†
                setTimeout(() => {
                    calendarLoading.style.display = 'none';
                    calendarBody.style.opacity = '1';
                }, 100);
            });
        }

        // æ‰“é–‹é ç´„æ¨¡æ…‹æ¡†
        function openBookingModal(date, time) {
            selectedBooking = { date, time };
            const dateObj = new Date(date);
            const formattedDate = `${dateObj.getFullYear()}å¹´${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥`;
            bookingDetails.textContent = `${formattedDate} ${time}`;
            bookingModal.style.display = 'flex';
        }

        // ç¢ºèªé ç´„
        async function confirmBooking() {
            if (!selectedBooking || !currentUser) return;
            
            // æª¢æŸ¥æ˜¯å¦å·²è¢«é ç´„
            const existingBooking = bookings.find(booking => 
                booking.date === selectedBooking.date && booking.time === selectedBooking.time
            );
            
            if (existingBooking) {
                showAlert('æ­¤æ™‚æ®µå·²è¢«é ç´„ï¼Œè«‹é¸æ“‡å…¶ä»–æ™‚æ®µ', 'error');
                bookingModal.style.display = 'none';
                return;
            }
            
            // æ–°å¢é ç´„
            const newBooking = {
                date: selectedBooking.date,
                time: selectedBooking.time,
                user: currentUser
            };
            
            // ğŸ”¥ å„²å­˜åˆ° Firebase
            const success = await addBooking(newBooking);
            
            if (success) {
                // å³æ™‚ç›£è½æœƒè‡ªå‹•æ›´æ–°ï¼Œä¸éœ€è¦æ‰‹å‹•åŠ å…¥
                // æ›´æ–°ä½¿ç”¨çµ±è¨ˆ
                updateUsageStats(currentUser);
                
                bookingModal.style.display = 'none';
                showAlert(`${currentUser} é ç´„æˆåŠŸï¼`, 'success');
            } else {
                showAlert('é ç´„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        }

        // æ‰“é–‹å–æ¶ˆé ç´„æ¨¡æ…‹æ¡†
        function openCancelModal(booking) {
            selectedBooking = booking;
            const dateObj = new Date(booking.date);
            const formattedDate = `${dateObj.getFullYear()}å¹´${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥`;
            cancelDetails.textContent = `${formattedDate} ${booking.time} (é ç´„äºº: ${booking.user})`;
            cancelModal.style.display = 'flex';
        }

        // ç¢ºèªå–æ¶ˆé ç´„
        async function confirmCancel() {
            if (!selectedBooking) return;
            
            // ğŸ”¥ å¾ Firebase åˆªé™¤
            const success = await deleteBooking(selectedBooking.id);
            
            if (success) {
                // å³æ™‚ç›£è½æœƒè‡ªå‹•æ›´æ–°ï¼Œä¸éœ€è¦æ‰‹å‹•ç§»é™¤
                // æ›´æ–°ä½¿ç”¨çµ±è¨ˆ
                updateUsageStats(currentUser);
                
                cancelModal.style.display = 'none';
                showAlert('é ç´„å·²å–æ¶ˆ', 'success');
            } else {
                showAlert('å–æ¶ˆé ç´„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        }

        // åˆ‡æ›åˆ°ä¸Šé€±
        function goToPrevWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            renderCalendar();
        }

        // åˆ‡æ›åˆ°ä¸‹é€±
        function goToNextWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            renderCalendar();
        }

        // åˆ‡æ›åˆ°æœ¬é€±
        function goToCurrentWeek() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() + diffToMonday);
            renderCalendar();
        }

        // å·¥å…·å‡½æ•¸
        function getFormattedDate(date) {
            return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
        }

        function formatMonth(month) {
            return month.toString().padStart(2, '0');
        }

        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }

        function calculateBookingRate() {
            const futureDates = [];
            const today = new Date();
            
            for (let i = 0; i < 14; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                futureDates.push(getFormattedDate(date));
            }
            
            const futureBookings = bookings.filter(booking => 
                futureDates.includes(booking.date)
            );
            
            const totalSlots = futureDates.length * 14;
            const bookingRate = totalSlots > 0 ? Math.round((futureBookings.length / totalSlots) * 100) : 0;
            return `${bookingRate}%`;
        }

        function showAlert(message, type) {
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 3000);
        }
    </script>
</body>
</html>